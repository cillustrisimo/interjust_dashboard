# Project Meridian
## A Global Tool to Increase Survivors' Access to Justice

(An interactive dashboard analyzing the criminalization of international crimes across 216 jurisdictions worldwide.)

*Based on research by the Clooney Foundation for Justice*

```js
//CELL 2: Data Loading
rawData = FileAttachment("Data_Interjust@2.csv").csv()
```

```table

```

```js
//CELL 3: Calculate Key Statistics
//Count countries with extraterritorial laws using the complex logic from the regional data
withLaws = rawData.filter(d => {
  const genocideJurisdiction = d["Jurisdiction GENOCIDE - NO perpetrator presence"] !== "N/A";
  const warCrimesJurisdiction = d["Jurisdiction WAR CRIMES - NO perpetrator presence"] !== "N/A";
  const cahJurisdiction = d["Jurisdiction CRIMES AGAINST HUMANITY - NO perpetrator presence"] !== "N/A";
  const aggressionJurisdiction = d["Jurisdiction AGGRESSION - NO perpetrator presence"] !== "N/A";
  return genocideJurisdiction || warCrimesJurisdiction || cahJurisdiction || aggressionJurisdiction;
}).length
```

```js
//CELL 4: Count Prosecutions
withCases = rawData.filter(d => 
  d["Jurisprudence - Has the country had a UJ or ETJ case? "] === "Yes"
).length
```

```js
//CELL 5: Display Summary Statistics
summaryStats = {
  return {
    "Total jurisdictions analyzed": rawData.length,
    "Countries with extraterritorial laws": withLaws,
    "Countries with actual prosecutions": withCases,
    "Implementation gap": withLaws - withCases,
    "Implementation rate": `${(withCases / withLaws * 100).toFixed(1)}%`
  };
}
```

```js
//CELL 7: Calculate Regional Data
regionalData = d3.rollup(rawData,
  v => ({
    total: v.length,
    withLaws: v.filter(d => {
      const genocideJurisdiction = d["Jurisdiction GENOCIDE - NO perpetrator presence"] !== "N/A";
      const warCrimesJurisdiction = d["Jurisdiction WAR CRIMES - NO perpetrator presence"] !== "N/A";
      const cahJurisdiction = d["Jurisdiction CRIMES AGAINST HUMANITY - NO perpetrator presence"] !== "N/A";
      const aggressionJurisdiction = d["Jurisdiction AGGRESSION - NO perpetrator presence"] !== "N/A";
      return genocideJurisdiction || warCrimesJurisdiction || cahJurisdiction || aggressionJurisdiction;
    }).length,
    withCases: v.filter(d => d["Jurisprudence - Has the country had a UJ or ETJ case? "] === "Yes").length
  }),
  d => d.Region
)
```

```js echo
//CELL 8: Region Selector
viewof selectedRegion = Inputs.select(
  ["All Regions", ...regionalData.keys()].sort(),
  {label: "Filter by region:", value: "All Regions"}
)
```

```js echo
// ============================================
// CELL 10: Interactive Bar Chart
implementationChart = {
  const width = 960;
  const height = 540;
  const margin = {top: 80, right: 160, bottom: 80, left: 80};
  
  // Filter data
  const filteredData = selectedRegion === "All Regions" 
    ? rawData 
    : rawData.filter(d => d.Region === selectedRegion);
  
  // Calculate metrics
  const total = filteredData.length;
  const withLaws = filteredData.filter(d => {
    const genocideJurisdiction = d["Jurisdiction GENOCIDE - NO perpetrator presence"] !== "N/A";
    const warCrimesJurisdiction = d["Jurisdiction WAR CRIMES - NO perpetrator presence"] !== "N/A";
    const cahJurisdiction = d["Jurisdiction CRIMES AGAINST HUMANITY - NO perpetrator presence"] !== "N/A";
    const aggressionJurisdiction = d["Jurisdiction AGGRESSION - NO perpetrator presence"] !== "N/A";
    return genocideJurisdiction || warCrimesJurisdiction || cahJurisdiction || aggressionJurisdiction;
  }).length;
  
  const withCases = filteredData.filter(d => 
    d["Jurisprudence - Has the country had a UJ or ETJ case? "] === "Yes"
  ).length;
  
  // Create SVG with subtle gradient background
  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, width, height])
    .attr("style", "width: 100%; height: auto; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;");
  
  // Add subtle background
  svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .attr("fill", "#FAFBFC");
  
  // Professional color scheme
  const colors = {
    total: "#4A5568",      // Slate gray
    laws: "#5B21B6",       // Deep purple  
    cases: "#059669"       // Emerald green
  };
  
  // Data for visualization
  const data = [
    {
      category: "Total Jurisdictions", 
      value: total, 
      color: colors.total,
      label: "All Countries Analyzed"
    },
    {
      category: "Extraterritorial Legislation", 
      value: withLaws, 
      color: colors.laws,
      label: "Can Prosecute Foreign Crimes"
    },
    {
      category: "Actual Prosecutions", 
      value: withCases, 
      color: colors.cases,
      label: "Have Used These Laws"
    }
  ];
  
  // Scales
  const x = d3.scaleBand()
    .domain(data.map(d => d.category))
    .range([margin.left, width - margin.right])
    .padding(0.35);
  
  const y = d3.scaleLinear()
    .domain([0, Math.max(220, total * 1.15)])
    .nice()
    .range([height - margin.bottom, margin.top]);
  
  // Grid lines
  svg.append("g")
    .attr("transform", `translate(${margin.left},0)`)
    .call(d3.axisLeft(y)
      .tickSize(-width + margin.left + margin.right)
      .tickFormat(d => d))
    .style("stroke-dasharray", "2,2")
    .style("opacity", 0.3)
    .call(g => g.select(".domain").remove())
    .call(g => g.selectAll(".tick line")
      .style("stroke", "#E5E7EB"))
    .call(g => g.selectAll(".tick text")
      .style("font-size", "12px")
      .style("fill", "#6B7280"));
  
  // X-axis
  svg.append("g")
    .attr("transform", `translate(0,${height - margin.bottom})`)
    .call(d3.axisBottom(x).tickSize(0))
    .call(g => g.select(".domain").remove())
    .call(g => g.selectAll(".tick text")
      .style("font-size", "13px")
      .style("font-weight", "500")
      .style("fill", "#374151"));
  
  // Bars with shadow effect
  const barGroup = svg.append("g");
  
  // Add shadows
  barGroup.selectAll(".shadow")
    .data(data)
    .join("rect")
    .attr("x", d => x(d.category) + 2)
    .attr("y", d => y(d.value) + 2)
    .attr("width", x.bandwidth())
    .attr("height", d => height - margin.bottom - y(d.value))
    .attr("fill", "#000")
    .attr("opacity", 0.1)
    .attr("rx", 6);
  
  // Main bars
  const bars = barGroup.selectAll(".bar")
    .data(data)
    .join("rect")
    .attr("class", "bar")
    .attr("x", d => x(d.category))
    .attr("y", height - margin.bottom)
    .attr("width", x.bandwidth())
    .attr("height", 0)
    .attr("fill", d => d.color)
    .attr("rx", 6);
  
  // Animate bars
  bars.transition()
    .duration(800)
    .delay((d, i) => i * 150)
    .attr("y", d => y(d.value))
    .attr("height", d => height - margin.bottom - y(d.value));
  
  // Value labels
  svg.selectAll(".value-label")
    .data(data)
    .join("text")
    .attr("class", "value-label")
    .attr("x", d => x(d.category) + x.bandwidth()/2)
    .attr("y", d => y(d.value) - 12)
    .attr("text-anchor", "middle")
    .style("font-size", "24px")
    .style("font-weight", "700")
    .style("fill", d => d.color)
    .text(d => d.value);
  
  // Percentage labels
  svg.selectAll(".percent-label")
    .data(data.slice(1))
    .join("text")
    .attr("x", (d, i) => x(d.category) + x.bandwidth()/2)
    .attr("y", d => y(d.value) - 36)
    .attr("text-anchor", "middle")
    .style("font-size", "13px")
    .style("fill", "#9CA3AF")
    .text((d, i) => i === 0 
      ? `${(withLaws/total*100).toFixed(1)}% of total`
      : `${(withCases/withLaws*100).toFixed(1)}% of those with laws`);
  
  // Description labels
  svg.selectAll(".desc-label")
    .data(data)
    .join("text")
    .attr("x", d => x(d.category) + x.bandwidth()/2)
    .attr("y", height - margin.bottom + 24)
    .attr("text-anchor", "middle")
    .style("font-size", "11px")
    .style("fill", "#9CA3AF")
    .style("font-style", "italic")
    .text(d => d.label);
  
  // Title
  svg.append("text")
    .attr("x", margin.left)
    .attr("y", 40)
    .style("font-size", "28px")
    .style("font-weight", "700")
    .style("fill", "#111827")
    .text(selectedRegion === "All Regions" 
      ? "Global Justice Implementation Gap" 
      : `${selectedRegion}: Implementation Analysis`);
  
  // Subtitle
  svg.append("text")
    .attr("x", margin.left)
    .attr("y", 64)
    .style("font-size", "16px")
    .style("fill", "#6B7280")
    .text(withLaws > 0
      ? `Only ${(withCases/withLaws*100).toFixed(1)}% of jurisdictions with extraterritorial laws have actually used them`
      : "No jurisdictions in this region have extraterritorial legislation");
  
  // Implementation gap indicator (if applicable)
  if (withLaws > 0 && withCases < withLaws) {
    const gapGroup = svg.append("g");
    
    // Curved arrow showing the gap
    //const midX = (x("Extraterritorial Legislation") + x("Actual Prosecutions") + x.bandwidth()) / 2;
    //const startY = y(withLaws);
    //const endY = y(withCases);
    
    //gapGroup.append("path")
      //.attr("d", `M ${x("Extraterritorial Legislation") + x.bandwidth()} ${startY - 10} 
                  //Q ${midX + 40} ${(startY + endY)/2} 
                  //${x("Actual Prosecutions")} ${endY - 10}`)
      //.attr("stroke", "#DC2626")
      //.attr("stroke-width", 2)
      //.attr("fill", "none")
      //.attr("marker-end", "url(#arrow)")
      //.style("opacity", 0.7);
    
    // Arrow marker
    //svg.append("defs").append("marker")
      //.attr("id", "arrow")
      //.attr("viewBox", "0 0 10 10")
      //.attr("refX", 5)
      //.attr("refY", 5)
      //.attr("markerWidth", 6)
      //.attr("markerHeight", 6)
      //.attr("orient", "auto")
      //.append("path")
      //.attr("d", "M 0 0 L 10 5 L 0 10 z")
      //.attr("fill", "#DC2626");
    
    // Gap label
    //gapGroup.append("text")
      //.attr("x", midX + 45)
      //.attr("y", (startY + endY)/2)
      //.style("font-size", "14px")
      //.style("font-weight", "600")
      //.style("fill", "#DC2626")
      //.text(`-${((withLaws - withCases)/withLaws*100).toFixed(0)}%`);
  }
  
  return svg.node();
}
```

# Bar Chart - Notes
1. How can we make this graph even more interactive? *What other filters can be used here? - Graph capturing more info*
   
2. Zoomable treemap (https://observablehq.com/@d3/zoomable-treemap) could be an alternative?

```js
crimeColumns = {
  return {
    genocide: "Genocide - Does the country criminalize genocide?",
    war: "War Crimes - Does the country criminalize war crimes?",
    cah: "Crimes Against Humanity - Does the country criminalize crimes against humanity?",
    aggression: "Aggression - Does the country criminalize the international crime of aggression or the crimes against peace?"
  };
}


```

```js
function to01(v) {
  const s = String(v ?? "").trim().toLowerCase();
  return s === "yes" || s === "true" || s === "1" || s === "y" || s === "sí" || s === "si" ? 1 : 0;
}
```

```js
crimeRows = {
  const rows = rawData.map(d => {
    const iso3 = String(d["ISO 3166-1 alpha-3"] || "").trim();
    const genocide   = to01(d[crimeColumns.genocide]);
    const war        = to01(d[crimeColumns.war]);
    const cah        = to01(d[crimeColumns.cah]);
    const aggression = to01(d[crimeColumns.aggression]);
    const criminalized_count = genocide + war + cah + aggression;
    return { iso3, genocide, war, cah, aggression, criminalized_count, Country: d.Country };
  });
  return rows;
}

```

```js
// TEST CELL - Expect a few sample rows with criminalized_count 0..4
crimeRows.slice(0, 5)

```

```js
countByISO = new Map(crimeRows.map(d => [d.iso3, d.criminalized_count]))
```

```js
countDist = ({
  0: crimeRows.filter(d => d.criminalized_count === 0).length,
  1: crimeRows.filter(d => d.criminalized_count === 1).length,
  2: crimeRows.filter(d => d.criminalized_count === 2).length,
  3: crimeRows.filter(d => d.criminalized_count === 3).length,
  4: crimeRows.filter(d => d.criminalized_count === 4).length
})
```

```js
// Loading GEOJSON
worldISO = await d3.json("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")

```

```js
colorScale = d3.scaleLinear()
  .domain([0, 4])
  .range(["#e6f0ff", "#08306b"])
```

```js
function DiscreteLegend({ scale, title = "", steps = [0,1,2,3,4], sw = 22, sh = 12, gap = 8, pad = 10 }) {
  const g = d3.create("svg:g");
  const fontSize = 12;

  // Title
  if (title) {
    g.append("text")
      .attr("x", 0)
      .attr("y", 0)
      .attr("dy", "0.8em")
      .attr("font-size", 13)
      .attr("font-weight", 600)
      .attr("fill", "#111827")
      .text(title);
  }

  const y0 = title ? 18 : 0;

  // Swatches + labels
  const row = g.append("g").attr("transform", `translate(0,${y0})`);

  steps.forEach((s, i) => {
    const x = i * (sw + 32); // space between swatches

    row.append("rect")
      .attr("x", x)
      .attr("y", 0)
      .attr("width", sw)
      .attr("height", sh)
      .attr("rx", 2)
      .attr("fill", scale(s) ?? "#eee")
      .attr("stroke", "#e5e7eb");

    row.append("text")
      .attr("x", x + sw + 6)
      .attr("y", sh / 2)
      .attr("dominant-baseline", "middle")
      .attr("font-size", fontSize)
      .attr("fill", "#374151")
      .text(String(s));
  });

  // Background box
  const bbox = g.node().getBBox();
  const bg = g.insert("rect", ":first-child")
    .attr("x", bbox.x - pad)
    .attr("y", bbox.y - pad)
    .attr("width", bbox.width + pad*2)
    .attr("height", bbox.height + pad*2)
    .attr("fill", "white")
    .attr("stroke", "#e5e7eb")
    .attr("rx", 6)
    .attr("opacity", 0.9);

  return g.node();
}

```

```js
choropleth = {
  const width = 980, height = 590;
  const margin = {top: 10, right: 10, bottom: 10, left: 10};

  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, width, height])
    .attr("style", "width: 100%; height: auto; font: 12px system-ui, sans-serif;");

  const projection = d3.geoEqualEarth()
    .fitExtent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]], {type: "Sphere"});

  const path = d3.geoPath(projection);

  // background sphere
  svg.append("path")
    .attr("d", path({type: "Sphere"}))
    .attr("fill", "#f8fafc");

  // countries
  svg.append("g")
    .selectAll("path")
    .data(worldISO.features)
    .join("path")
      .attr("d", path)
      .attr("fill", d => {
        const iso = String(d.properties?.["ISO3166-1-Alpha-3"] || "").trim();
        const c = countByISO.get(iso);
        return c == null ? "#eeeeee" : colorScale(c);
      })
      .attr("stroke", "#fff")
      .attr("stroke-width", 0.5)
    .append("title")
      .text(d => {
        const p = d.properties || {};
        const name = p.name ?? p.ADMIN ?? p.admin ?? "Unknown";
        const iso  = String(p["ISO3166-1-Alpha-3"] || "").trim();
        const c    = countByISO.get(iso);
        return `${name} (${iso || "—"})\nCrimes criminalized: ${c ?? "No data"}/4`;
      });

  // gentle graticule
  const graticule = d3.geoGraticule10();
  svg.insert("path", ":first-child")
    .attr("d", path(graticule))
    .attr("fill", "none")
    .attr("stroke", "#e5e7eb")
    .attr("stroke-width", 0.5);

 // Legend (discrete 0..4) — top-left inside the map
svg.append("g")
  .attr("transform", `translate(${margin.left + 12}, ${margin.top + 12})`)
  .append(() => DiscreteLegend({
    scale: colorScale,
    title: "Number of serious crimes criminalized",
    steps: [0,1,2,3,4]
  }));


  return svg.node();
}
```

# Choropleth - Notes
1. We can Include a filter function like the one above to color Total Count and by crime?
2. ~~I want to try to build a Versor-Dragging globe and *print* the choropleth on top.~~
3. Add a Zoom In - Zoom Out Feature: *Crimes in their criminal statute: 2.* (https://observablehq.com/@d3/seamless-zoomable-map-tiles)
4. The hover 'pop up' could also give a detailed breakdown by crimes instead of a total count (?)

# ~~Versor Dragging DRAFT~~

```js
versor = (await import("https://cdn.jsdelivr.net/npm/versor@0.0.4/+esm")).default

```

```js
// Low-res world (properties.name), good enough for dragging
worldLow = await d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
// quick sanity: [worldLow.type, worldLow.features.length]

```

```js
nameToISO = new Map(
  worldISO.features.map(f => {
    const p = f.properties || {};
    const name = p.name ?? p.ADMIN ?? p.admin ?? "";
    const iso  = String(p["ISO3166-1-Alpha-3"] || "").trim();
    return [name, iso];
  })
)

```

```js
dragFeatures = worldLow.features.map(f => {
  const name = f?.properties?.name ?? "";
  const iso = nameToISO.get(name) || ""; // blank means “no data”
  return { f, iso };
})

```

```js
globe = {
  const width = 680, height = 680; // slightly smaller = faster

  const context = DOM.context2d(width, height);
  const canvas = context.canvas;

  const projection = d3.geoOrthographic()
    .translate([width / 2, height / 2])
    .scale(Math.min(width, height) * 0.45)
    .clipAngle(90);

  const path = d3.geoPath(projection, context);
  const graticule = d3.geoGraticule10();

  let dragging = false;
  let rafPending = false;

  function render() {
    rafPending = false;
    
// keep longitude in [-180, 180)
const wrap = λ => ((λ + 180) % 360) - 180;

// pixels → degrees at the equator for geoOrthographic
const degPerPx = 180 / (Math.PI * projection.scale());
    
    context.clearRect(0, 0, width, height);

    // Sphere
    context.beginPath();
    path({ type: "Sphere" });
    context.fillStyle = "#f8fafc";
    context.fill();

    if (!dragging) {
      // Graticule only when idle (costs draw time)
      context.beginPath();
      path(graticule);
      context.strokeStyle = "#e5e7eb";
      context.lineWidth = 0.5;
      context.stroke();
    }

    if (dragging) {
      // FAST PATH: low-res features, no strokes
      for (const {f, iso} of dragFeatures) {
        const c = countByISO.get(iso);
        context.beginPath();
        path(f);
        context.fillStyle = c == null ? "#eeeeee" : colorScale(c);
        context.fill();
      }
    } else {
      // CRISP PATH: high-res features with strokes
      for (const f of worldISO.features) {
        const iso = String(f.properties?.["ISO3166-1-Alpha-3"] || "").trim();
        const c = countByISO.get(iso);

        context.beginPath();
        path(f);
        context.fillStyle = c == null ? "#eeeeee" : colorScale(c);
        context.fill();

        context.strokeStyle = "#ffffff";
        context.lineWidth = 0.6;
        context.stroke();
      }
    }
  }

  function scheduleRender() {
    if (!rafPending) {
      rafPending = true;
      requestAnimationFrame(render);
    }
  }

  // Constrained spin-only drag (no RAF throttle)
let x0 = 0, λ0 = 0, degPerPx = 0;

d3.select(canvas).call(
  d3.drag()
    .on("start", (event) => {
      x0 = event.x;
      λ0 = projection.rotate()[0];
      degPerPx = 180 / (Math.PI * projection.scale()); // px → deg at equator
      dragging = true;   // if you use this flag inside render()
      render();          // draw once immediately
    })
    .on("drag", (event) => {
      const dx = event.x - x0;                  // horizontal only
      const λ  = ((λ0 + dx * degPerPx + 180) % 360) - 180; // wrap to [-180,180)
      projection.rotate([λ, 0, 0]);             // lock φ=0, γ=0
      render();                                  // <-- force paint each event
    })
    .on("end", () => {
      dragging = true;
      render();                                  // final crisp paint
    })
);


  render();
  return canvas;
}

```

```js echo
isoFromFeature = f => String(f?.properties?.["ISO3166-1-Alpha-3"] || "").trim();

```

```js echo
matchTotal = worldISO.features.length

```

```js echo
matchMatched = worldISO.features.filter(f => countByISO.has(isoFromFeature(f))).length

```

# ~~Sankey Attempt~~

```js
//CELL 6: Import d3 Sankey
d3Sankey = require("d3-sankey@0.12")
```

```js
//CELL 9: Enhanced Sankey Data (FIXED)
enhancedSankeyData = {
  // Fix: Check for "All Regions" not "All"
  const selectedData = selectedRegion === "All Regions" 
    ? rawData
    : rawData.filter(d => d.Region === selectedRegion);
  
  // Use the same complex logic for counting as in withLaws calculation
  const hasETLaws = selectedData.filter(d => {
    const genocideJurisdiction = d["Jurisdiction GENOCIDE - NO perpetrator presence"] !== "N/A";
    const warCrimesJurisdiction = d["Jurisdiction WAR CRIMES - NO perpetrator presence"] !== "N/A";
    const cahJurisdiction = d["Jurisdiction CRIMES AGAINST HUMANITY - NO perpetrator presence"] !== "N/A";
    const aggressionJurisdiction = d["Jurisdiction AGGRESSION - NO perpetrator presence"] !== "N/A";
    return genocideJurisdiction || warCrimesJurisdiction || cahJurisdiction || aggressionJurisdiction;
  });
  
  const prosecuted = selectedData.filter(d => 
    d["Jurisprudence - Has the country had a UJ or ETJ case? "] === "Yes"
  );
  
  // Calculate basic flows
  const totalCountries = selectedData.length;
  const hasLawsCount = hasETLaws.length;
  const noLawsCount = totalCountries - hasLawsCount;
  const prosecutedCount = prosecuted.length;
  const lawsOnlyCount = hasLawsCount - prosecutedCount;
  
  // Simple node structure with numeric IDs
  const nodes = [
    { id: 0, name: "All Countries" },
    { id: 1, name: "Has ET Laws" },
    { id: 2, name: "No ET Laws" },
    { id: 3, name: "Actually Prosecuted" },
    { id: 4, name: "Laws Only" }
  ];
  
  // Create links with proper values
  const links = [
    { source: 0, target: 1, value: hasLawsCount },
    { source: 0, target: 2, value: noLawsCount },
    { source: 1, target: 3, value: prosecutedCount },
    { source: 1, target: 4, value: lawsOnlyCount }
  ].filter(link => link.value > 0);
  
  return { nodes, links };
}
```

```js echo
import {Treemap} from "@d3/treemap"
```
